{% extends "base.html" %}
{% load static %}


{% block title %}All Reviews{% endblock title %}

{% block content %}
<button id="btn-back" class="mt-12 bg-[#a7bf6e] hover:bg-[#4f4f4f] text-white font-semibold py-3 px-8 rounded-md shadow-md transition">
    < Kembali ke Detail Lapangan
</button>

<h1 id="ulasan" style="margin-top: 56px; margin-bottom:28px; display: flex;width: 1000px;height: 38px;flex-direction: column;justify-content: center;flex-shrink: 0; color: var(--Foundation-Primary-primary-900, #4D5833);font-size: 32px;font-style: normal;font-weight: 600;line-height: 120%;">Ulasan untuk {{ field.nama_lapangan }}</h1>
{% include 'rating_stats.html' %}

<div style="display: flex; justify-content: flex-end; width: 100%;">
  <button id="btn-tambah-ulasan"
    class="mt-8 mb-8 bg-[#a7bf6e] hover:bg-[#4f4f4f] text-white font-semibold py-3 px-8 rounded-md shadow-md transition">
    + Tambah Ulasan
  </button>
</div>

<div class="all-reviews" style="display: flex; flex-direction: column; align-items: flex-start; gap: 40px; align-self: stretch; width: 100%;">
  {% for review in reviews %}
  <div class="container" style="display: flex; flex-direction: column; align-items: flex-end; gap: 16px; align-self: stretch; width: 100%; padding-bottom: 24px; border-bottom: 1px solid #ddd;">
    <div class="profile" style="position: relative; display: flex; align-items: center; gap: 24px; align-self: stretch;">
      <div class="h-8 w-8 rounded-full bg-[#CFE1A5] flex items-center justify-center text-[#4F4F4F] font-bold text-sm border-2 border-primary">
          {{ user.username.0|upper }}
      </div>
      <div class="profile-name">
        <h1 style="font-family: Montserrat; font-size: 20px; font-weight: 600; color: #212121; line-height: 120%;">
          {{ review.user.user.username }}
        </h1>
        <p style="font-family: Montserrat; font-size: 13px; font-weight: 400; line-height: 120%; letter-spacing: 0.26px;">
          {{ review.created_at|date:"d M Y H:i" }}
        </p>
      </div>
      {% if review.is_owner %}
        <!-- Three dots button -->
        <button class="dots-btn" style="position: absolute; right: 0; background: none; border: none; font-size: 20px; cursor: pointer;">
          ‚ãÆ
        </button>

        <!-- Dropdown menu -->
        <div class="dropdown-menu" style="display: none; position: absolute; right: 0; top: 28px; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10;">
          <button class="edit-btn" style="display: block; width: 100%; text-align: left; padding: 8px 12px; background: none; border: none; cursor: pointer;">‚úèÔ∏è Edit</button>
          <button class="delete-btn" style="display: block; width: 100%; text-align: left; padding: 8px 12px; background: none; border: none; color: red; cursor: pointer;">üóëÔ∏è Hapus</button>
        </div>
      {% endif %}
    </div>
    <div class="review-content" style="display: flex; width: 100%; flex-direction: column; align-items: flex-start; gap: 32px;">
      <p style="text-align: justify; font-family: Montserrat; font-size: 20px; color: #212121; font-weight: 500; line-height: 120%; letter-spacing: 0.4px;">
        {{ review.content }}
      </p>
      <div class="rating" style="color: #FFD700; font-size: 18px;">
        {% for i in "12345" %}
          {% if forloop.counter <= review.rating %}
            ‚òÖ
          {% else %}
            ‚òÜ
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<div id="HapusModal" 
     class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[100]">
  <div class="bg-white rounded-xl shadow-2xl p-8 max-w-sm w-full text-center animate-fade-in">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Anda yakin ingin menghapus ulasan?</h2>
    <p class="text-gray-600 mb-6">Ulasan yang dihapus tidak bisa dimunculkan kembali</p>
    <div class="flex justify-center gap-4">
      <button id="btnBatalLogin" 
              class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">
        Batal
      </button>
      <a id="btnHapus" 
         class="px-4 py-2 bg-[#F01000] text-white rounded-lg hover:bg-[#AA0B00] cursor-pointer">
        Hapus
      </a>
    </div>
  </div>
</div>


{% include "modal_input.html" %}
{% include 'toast.html' %}

<div class="flex justify-center items-center mt-8 mb-4 space-x-2">
  {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}{% if selected_jenis != 'all' %}&jenis={{ selected_jenis }}{% endif %}{% if selected_rating != 'all' %}&rating={{ selected_rating }}{% endif %}"
      class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&laquo; Prev</a>
  {% endif %}

  {% for num in page_obj.paginator.page_range %}
    {% if num == page_obj.number %}
      <span class="px-3 py-1 bg-[#a7bf6e] text-white rounded">{{ num }}</span>
    {% else %}
      <a href="?page={{ num }}{% if selected_jenis != 'all' %}&jenis={{ selected_jenis }}{% endif %}{% if selected_rating != 'all' %}&rating={{ selected_rating }}{% endif %}"
        class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">{{ num }}</a>
    {% endif %}
  {% endfor %}

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}{% if selected_jenis != 'all' %}&jenis={{ selected_jenis }}{% endif %}{% if selected_rating != 'all' %}&rating={{ selected_rating }}{% endif %}"
      class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next &raquo;</a>
  {% endif %}
</div>


<script>
const field_id = "{{ field.id }}";
fetch(`/review/${field_id}/`, {
  headers: { "x-requested-with": "XMLHttpRequest" }
})
  .then(res => res.json())
  .then(data => {
    document.querySelector('.all-reviews').innerHTML = '';

    data.reviews.forEach(r => {
      const container = document.createElement('div');
      container.classList.add('container');
      container.style.display = 'flex';
      container.style.flexDirection = 'column';
      container.style.alignItems = 'flex-end';
      container.style.gap = '16px';
      container.style.borderBottom = '1px solid #ddd';
      container.style.paddingBottom = '24px';
      container.setAttribute('data-review-id', r.id);

      container.innerHTML = `
        <div class="profile" style="position: relative; display: flex; align-items: center; gap: 24px; align-self: stretch;">
          <div class="h-8 w-8 rounded-full bg-[#CFE1A5] flex items-center justify-center text-[#4F4F4F] font-bold text-sm border-2 border-primary">
            ${r.user.charAt(0).toUpperCase()}
          </div>
          <div class="profile-name">
            <h1 style=" font-size: 24px; font-weight: 600; color: #212121;">
              ${r.user}
            </h1>
            <p style="font-size: 13px; color: #555;">
              ${r.created_at}
            </p>
          </div>
        </div>

        <div class="review-content" style="display: flex; width: 100%; flex-direction: column; align-items: flex-start; gap: 32px;">
          <p style="text-align: justify; font-size: 20px; color: #212121; font-weight: 400; line-height: 120%; letter-spacing: 0.4px;">
            ${r.content}
          </p>
          <div class="rating" style="color: #FFD700; font-size: 18px;">
            ${"‚òÖ".repeat(r.rating)}${"‚òÜ".repeat(5 - r.rating)}
          </div>
        </div>
      `;

      if (r.is_owner) {
        const dotsBtn = document.createElement('button');
        dotsBtn.classList.add('dots-btn');
        dotsBtn.innerHTML = '‚ãÆ';
        dotsBtn.style.position = 'absolute';
        dotsBtn.style.right = '10px';
        dotsBtn.style.top = '5px';
        dotsBtn.style.background = 'none';
        dotsBtn.style.border = 'none';
        dotsBtn.style.fontSize = '20px';
        dotsBtn.style.cursor = 'pointer';

        const dropdownMenu = document.createElement('div');
        dropdownMenu.classList.add('dropdown-menu');
        dropdownMenu.style.display = 'none';
        dropdownMenu.style.position = 'absolute';
        dropdownMenu.style.right = '0';
        dropdownMenu.style.top = '28px';
        dropdownMenu.style.background = 'white';
        dropdownMenu.style.border = '1px solid #ddd';
        dropdownMenu.style.borderRadius = '6px';
        dropdownMenu.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        dropdownMenu.style.zIndex = '10';

        dropdownMenu.innerHTML = `
          <button class="edit-btn" style="display: block; width: 100%; text-align: left; padding: 8px 12px; background: none; border: none; cursor: pointer;">‚úèÔ∏è Edit</button>
          <button class="delete-btn" style="display: block; width: 100%; text-align: left; padding: 8px 12px; background: none; border: none; color: red; cursor: pointer;">üóëÔ∏è Hapus</button>
        `;

        const profileDiv = container.querySelector('.profile');
        profileDiv.appendChild(dotsBtn);
        profileDiv.appendChild(dropdownMenu);

        dotsBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const isVisible = dropdownMenu.style.display === 'block';
          document.querySelectorAll('.dropdown-menu').forEach(m => m.style.display = 'none');
          dropdownMenu.style.display = isVisible ? 'none' : 'block';
        });

        document.addEventListener('click', () => {
          dropdownMenu.style.display = 'none';
        });

        dropdownMenu.querySelector('.delete-btn').addEventListener('click', () => {
          const modal = document.getElementById('HapusModal');
          const btnBatal = document.getElementById('btnBatalLogin');
          const btnHapus = document.getElementById('btnHapus');

          modal.classList.remove('hidden');
          modal.classList.add('flex');

          btnBatal.onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
          };

          btnHapus.onclick = () => {
            fetch(`/review/delete/${r.id}/`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': getCookie('csrftoken'),
              },
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                container.remove();
                showToast('Berhasil', 'Ulasan berhasil dihapus', 'success');
              } else {
                showToast('Gagal', data.error || 'Terjadi kesalahan', 'error');
              }

              modal.classList.add('hidden');
              modal.classList.remove('flex');
              loadRatingStatistics(field_id);

            })
            .catch(() => {
              showToast('Gagal', 'Terjadi kesalahan jaringan', 'error');
              modal.classList.add('hidden');
              modal.classList.remove('flex');
            });
          };
        });

        dropdownMenu.querySelector('.edit-btn').addEventListener('click', () => {
        const modal = document.getElementById('review-modal');
        const modalTitle = document.getElementById('modal-title');
        const contentInput = document.getElementById('content');
        const submitBtn = document.getElementById('submit-btn');
        const stars = modal.querySelectorAll('.star');

        modal.dataset.mode = 'edit';
        modal.dataset.reviewId = r.id;
        
        modalTitle.textContent = "Edit Ulasan";
        submitBtn.textContent = "Simpan";

        contentInput.value = r.content;
        selectedRating = r.rating;

        stars.forEach((s, i) => {
          s.textContent = i < r.rating ? '‚òÖ' : '‚òÜ';
        });

        dropdownMenu.style.display = 'none';

        modal.style.display = 'flex';

        loadRatingStatistics(field_id);

      });

      }
      document.querySelector('.all-reviews').appendChild(container);
    });
  });

  function openModal() {
    document.getElementById('review-modal').style.display = 'flex';
  }

function closeModal() {
  const modal = document.getElementById('review-modal');
  const modalTitle = document.getElementById('modal-title');
  const submitBtn = document.getElementById('submit-btn');
  
  modal.style.display = 'none';
  modal.dataset.mode = 'add';
  modal.dataset.reviewId = '';
  
  modalTitle.textContent = "Tambah Ulasan";
  submitBtn.textContent = "Kirim";
  
  document.getElementById('content').value = '';
  selectedRating = 0;
  document.querySelectorAll('.star').forEach(s => s.textContent = '‚òÜ');
}

  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('btn-tambah-ulasan');
    if (btn) {
      btn.addEventListener('click', openModal);
    }
  });

  function showToast(title, message, type = "info", duration = 3000) {
    const toast = document.getElementById("toast-component");
    const icon = document.getElementById("toast-icon");
    const toastTitle = document.getElementById("toast-title");
    const toastMessage = document.getElementById("toast-message");

    toastTitle.innerText = title;
    toastMessage.innerText = message;

    let bgColor = "bg-gray-200";
    icon.innerHTML = "‚ÑπÔ∏è";

    if (type === "success") { bgColor = "bg-green-100"; icon.innerHTML = "‚úÖ"; }
    else if (type === "error") { bgColor = "bg-red-100"; icon.innerHTML = "‚ùå"; }

  toast.classList.remove("opacity-0", "translate-y-10", "pointer-events-none");
  toast.classList.add("opacity-100", bgColor);

  clearTimeout(toast.hideTimeout);

  toast.hideTimeout = setTimeout(() => {
    toast.classList.remove("opacity-100");
    toast.classList.add("opacity-0", "translate-y-10");

    setTimeout(() => {
      toast.classList.add("pointer-events-none");
      toast.classList.remove(bgColor);
      toastTitle.innerText = "";
      toastMessage.innerText = "";
    }, 300);
  }, duration);  }

window.currentFieldId = "{{ field.id }}";
document.body.dataset.fieldId = "{{ field.id }}";

</script>


{% endblock %}