{% extends 'base.html' %} 
{% load static %}
{% load custom_filters %} 
{% comment %} MENGHAPUS: {% load humanize %} {% endcomment %}

{% block title %}{{ lapangan_terpilih.nama_lapangan }} Booking{% endblock %}

{% block content %}
<div class="py-10">
    
    {# -------------------------------------------------------- #}
    {# SECTION: VISUAL HERO / HEADER LAPANGAN (IMAGE)           #}
    {# -------------------------------------------------------- #}
    <div class="relative w-full h-80 overflow-hidden rounded-md shadow-xl mb-8">
        <img src="{% static 'images/lapangan_default.jpg' %}" 
             alt="Visual Lapangan {{ lapangan_terpilih.nama_lapangan }}"
             class="w-full h-full object-cover transition duration-300 hover:scale-105"
             onerror="this.onerror=null;this.src='https://via.placeholder.com/1200x500?text=GOR+Visual';"
        >
        <div class="absolute inset-0 bg-black bg-opacity-30 flex items-end p-6">
            <h1 class="text-4xl font-bold text-white">{{ lapangan_terpilih.nama_lapangan|default:"Pilih Lapangan" }}</h1>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        
        {# -------------------------------------------------------- #}
        {# SECTION: FILTER CONTROLS (DROPDOWN LAPANGAN & TANGGAL)   #}
        {# Ini mengimplementasikan Aturan Wajib: Filter Data        #}
        {# -------------------------------------------------------- #}
        <header class="mb-8 p-6 bg-white shadow-sm rounded-md">
            <h2 class="text-2xl font-bold text-gray-800">Booking Lapangan</h2>
            
            <form id="filter-form" method="GET" class="flex flex-col md:flex-row gap-4 mt-4">
                
                {# Filter Dropdown Lapangan #}
                <div class="flex-grow">
                    <label for="lapangan_id_filter" class="block text-sm font-medium text-gray-700">Pilih Lapangan</label>
                    <select name="lapangan_id" id="lapangan_id_filter" onchange="this.form.submit()" 
                            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-primary focus:ring-primary focus:border-primary rounded-md">
                        {% for lapangan in all_lapangan %}
                            <option value="{{ lapangan.pk }}" {% if lapangan == lapangan_terpilih %}selected{% endif %}>
                                {{ lapangan.nama_lapangan }} ({{ lapangan.jenis_olahraga }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                {# Filter Input Tanggal #}
                <div class="flex-grow">
                    <label for="date_filter" class="block text-sm font-medium text-gray-700">Pilih Tanggal Booking:</label>
                    <input type="date" name="date" id="date_filter" value="{{ filter_date_str }}" 
                           min="{{ today|date:'Y-m-d' }}" 
                           onchange="this.form.submit()"
                           class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:ring-primary focus:border-primary rounded-md">
                </div>
            </form>
            
            {% if lapangan_terpilih %}
            <p class="text-xl font-bold text-primary mt-3">
                Harga/Jam: Rp {{ lapangan_terpilih.harga_per_jam|floatformat:0 }}
            </p>
            {% endif %}
        </header>
        
        <h3 class="text-xl font-bold text-gray-800 mb-4">Pilih Sesi</h3>
        
        {# -------------------------------------------------------- #}
        {# SECTION: GRID SLOT JADWAL (7 HARI TABLE / CARD)          #}
        {# -------------------------------------------------------- #}
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
            
            {% for slot_date in date_list %}
            <div class="bg-white p-3 rounded-xl shadow-sm flex flex-col min-h-[300px]">
                
                {# Slot Header (Tanggal dan Hari) #}
                <div class="text-center pb-2 mb-3 border-b border-gray-200">
                    <p class="text-xs font-semibold uppercase {% if slot_date == today %}text-yellow-600{% else %}text-primary{% endif %}">
                        {{ slot_date|date:"D" }}
                    </p>
                    <p class="text-xl font-bold text-gray-800">{{ slot_date|date:"d M" }}</p>
                </div>
                
                {# Daftar Card Slot Waktu #}
                <div class="space-y-2 flex-grow">
                    {% with slots_by_date|get_item:slot_date as slots %} 
                        {% if slots %}
                            {% for slot in slots %}
                                <div 
                                    data-slot-id="{{ slot.id }}"
                                    data-available="{{ slot.is_available|lower }}"
                                    class="slot-card p-2 rounded-lg border border-gray-300 text-center 
                                           {% if slot.is_available %}cursor-pointer hover:shadow-lg transition duration-150{% else %}unavailable{% endif %}">
                                    
                                    <p class="text-sm font-semibold mb-1 
                                            {% if slot.is_available %}text-gray-800{% else %}text-gray-500{% endif %}">
                                        {{ slot.jam_mulai|date:"H:i" }} - {{ slot.jam_akhir|date:"H:i" }}
                                    </p>
                                    <p class="text-lg font-bold 
                                            {% if slot.is_available %}text-primary{% else %}text-gray-400{% endif %}">
                                        {% if slot.is_available %}
                                            Rp {{ slot.lapangan.harga_per_jam|floatformat:0 }}
                                        {% else %}
                                            BOOKED
                                        {% endif %}
                                    </p>

                                    <span class="text-xs font-bold uppercase mt-2 px-2 py-0.5 rounded 
                                        {% if slot.is_available %}bg-yellow-100 text-yellow-600{% else %}bg-red-100 text-red-600{% endif %}">
                                        {% if slot.is_available %}AVAILABLE{% else %}BOOKED{% endif %}
                                    </span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-center text-sm text-gray-500 py-4">Booking Session untuk hari ini belum dibuka.</p>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
            {% endfor %}
            
        </div>
        
        {# -------------------------------------------------------- #}
        {# SECTION: FLOATING CHECKOUT BUTTON (ACTION & MESSAGES)    #}
        {# Mengimplementasikan Aturan Wajib: Form & AJAX            #}
        {# -------------------------------------------------------- #}
        <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-2xl p-4 z-40">
            <div class="max-w-7xl mx-auto flex justify-end items-center">
                
                <button id="btn-lanjut-bayar" disabled
                        class="px-8 py-3 bg-primary text-white font-bold rounded-lg shadow-xl 
                               disabled:opacity-50 transition duration-300">
                    Lanjut Pembayaran <i class="fas fa-arrow-right mr-2"></i>
                </button>
            </div>
            <div id="message-area" class="text-center text-sm mt-2"></div>
        </div>

    </div>
</div>
{% endblock content %}

{# -------------------------------------------------------- #}
{# SECTION: JAVASCRIPT (LOGIC AJAX & DOM MANIPULATION)      #}
{# -------------------------------------------------------- #}
{% block extra_script %}
<script>
    let selectedSlotId = null;
    const btnBayar = document.getElementById('btn-lanjut-bayar');
    const slotCards = document.querySelectorAll('.slot-card');
    const messageArea = document.getElementById('message-area');

    // 1. Logic Pemilihan Slot
    slotCards.forEach(card => {
        card.addEventListener('click', () => {
            if (card.dataset.available === 'true') {
                // Hapus seleksi sebelumnya
                document.querySelectorAll('.slot-card').forEach(c => c.classList.remove('selected', 'border-primary', 'bg-green-50'));
                
                // Tandai card yang dipilih (style Tailwind)
                card.classList.add('selected', 'border-primary', 'bg-green-50');
                selectedSlotId = card.dataset.slotId;
                btnBayar.disabled = false;
                messageArea.innerHTML = '';
            } else {
                messageArea.innerHTML = '<span class="text-red-500">Slot ini sudah dibooking.</span>';
            }
        });
    });

    // 2. Logika Tombol Lanjut Pembayaran (AJAX Wajib)
    btnBayar.addEventListener('click', async function() {
        if (!selectedSlotId) {
            messageArea.innerHTML = '<span class="text-red-500">Pilih slot terlebih dahulu.</span>';
            return;
        }

        // Nonaktifkan tombol saat proses
        btnBayar.disabled = true;
        btnBayar.textContent = 'Memproses Booking...';
        messageArea.innerHTML = '<span class="text-primary">Harap tunggu...</span>';

        try {
            const response = await fetch("{% url 'booking:create_booking' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // Gunakan @csrf_exempt di views.py untuk development
                },
                body: JSON.stringify({ slot_id: selectedSlotId })
            });

            const result = await response.json();

            if (response.ok) {
                const bookingId = result.booking_id;
                messageArea.innerHTML = '<span class="text-green-600">Booking berhasil!</span>';
                setTimeout(() => {
                    // Redirect ke URL pembayaran
                    window.location.href = `{% url 'booking:show_payment_page' 0 %}`.replace('0', bookingId);
                }, 1000);
            } else if (response.status === 403) {
                throw new Error('Login Required');
            } else {
                throw new Error(result.message || "Gagal membuat booking.");
            }

        } catch (error) {
            btnBayar.disabled = false;
            btnBayar.textContent = 'Lanjut Pembayaran';
            if (error.message === 'Login Required') {
                messageArea.innerHTML = '<span class="text-red-500">Anda harus login untuk booking.</span>';
            } else {
                messageArea.innerHTML = `<span class="text-red-500">${error.message}</span>`;
            }
        }
    });
</script>
{% endblock extra_script %}